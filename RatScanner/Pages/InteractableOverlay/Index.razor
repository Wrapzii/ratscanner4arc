@page "/interactableOverlay"
@using RatScanner.Scan
@using Task = System.Threading.Tasks.Task;
@using RatScanner.View;
@using Color = MudBlazor.Color
@using System.Diagnostics;
@using RatScanner.Pages.InteractableOverlay.Services;
@using RatScanner.Pages.InteractableOverlay.Components;
@using SearchResult = RatScanner.Pages.InteractableOverlay.Services.SearchResult;
@inject MenuVM MenuVM
@inject RatScanner.VirtualScreenOffset VirtualScreenOffset
@inject SettingsVM SettingsVM;
@inject IJSRuntime JSRuntime;
@implements IDisposable

<div id="click-away-background" style="position: absolute; width: 100%; height: 100%;"
     onmousedown="if (event.target == this) DotNet.invokeMethodAsync('RatScanner', 'JSHideOverlay')"></div>
<div style="width: 100%; height: 100%;">
    <div style="position: relative; top: 20%; pointer-events: none;">
        <div class="d-flex align-content-center justify-center">
            <div style="width: 40vw; pointer-events: auto;">
                <MudPaper>
                    <MudTextField @ref="_searchTextField" T="string" Variant="Variant.Outlined"
                                  Adornment="Adornment.End" AdornmentIcon="@Icons.Material.Filled.Search"
                                  DebounceInterval="20" OnDebounceIntervalElapsed="ExecuteSearch" @bind-Value="@_searchText">
                    </MudTextField>
                </MudPaper>

                <MudStack Spacing="2" Class="py-2">
                    @for (int _i = 0; _i < _searchResults.Count(); _i++) {
                        int i = _i;
                        SearchResult searchResult = _searchResults.ElementAt(i);

                        if (searchResult.Data is ArcRaidersData.ArcItem item) {
                            <ItemSearchResult Item="@item" IsExpanded="@(i == 0)" />
                        }
                    }
                </MudStack>
            </div>
        </div>
    </div>
</div>

@code {
    private static MudTextField<string> _searchTextField { get; set; } = null!;
    private string _searchText { get; set; } = "";
    private IEnumerable<SearchResult> _searchResults { get; set; } = new List<SearchResult>();
    private readonly SearchService _searchService = new();

    private async void ExecuteSearch(string value) {
        var sanitizedValue = _searchService.SanitizeSearch(value);
        var results = Enumerable.Empty<SearchResult>();
        results = results.Concat(await _searchService.SearchItemsAsync(sanitizedValue));
        results = results.Where(result => result != null && result.Data != null);
        results = results.OrderBy(result => result.Score).Take(4);
        _searchResults = results;
    }

    [JSInvokable]
    public static void JSHideOverlay() {
        BlazorUI.BlazorInteractableOverlay.HideOverlay();
    }

    [JSInvokable]
    public static void JSShowOverlay() {
        _searchTextField.FocusAsync();
        _searchTextField.SelectAsync();
    }

    protected override void OnInitialized() {
        MenuVM.PropertyChanged += PropertyChangeHandler;
    }

    private async void PropertyChangeHandler(object? sender, EventArgs e) {
        await InvokeAsync(() => StateHasChanged());
    }

    public void Dispose() {
        MenuVM.PropertyChanged -= PropertyChangeHandler;
    }
}
