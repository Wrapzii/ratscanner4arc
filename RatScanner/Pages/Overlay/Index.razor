@page "/overlay"
@using RatScanner.Scan
@using System.Globalization
@inject MenuVM MenuVM
@inject RatScanner.VirtualScreenOffset VirtualScreenOffset
@inject SettingsVM SettingsVM;
@inject IJSRuntime JSRuntime;
@implements IDisposable

<MinimapOverlay />

<div style="transform-origin: top left; transform: scale(@((1f / SettingsVM.ScreenScale).ToString(CultureInfo.InvariantCulture)));">
    @foreach (var itemScan in MenuVM.ItemScans)
    {
        var item = itemScan.Item;
        @if (itemScan != null
       && itemScan.GetToolTipPosition() != null
       && itemScan.DissapearAt > DateTimeOffset.Now.ToUnixTimeMilliseconds())
        {
            @if (itemScan is ItemIconScan iconScan)
            {
                var leftPos = iconScan.GetToolTipPosition().X - VirtualScreenOffset.XOffset;
                var topPos = iconScan.GetToolTipPosition().Y - VirtualScreenOffset.YOffset;
                var width = iconScan.Icon.ItemSize.X;
                var height = iconScan.Icon.ItemSize.Y;

                <div style="font-size: smaller; position: absolute; left: @(leftPos)px; top: @(topPos)px; width: @(width)px; height: @(height)px; ">
                    <div style="position: relative; width: 100%; height: 100%;
	                            text-shadow: 0px 0px 5px black;
	                            outline-offset: -1px;
	                            outline: 1px solid #495154;" class="pa-1">
                        @{
                            var iconStyle = iconScan.Rotated ? "transform: rotate(90deg) translate(0%, -100%);" : "";
                            var mWidth = iconScan.Rotated ? height : width;
                            var mHeight = iconScan.Rotated ? width : height;
                        }
                        <div style="position: absolute; width: 100%; height: 100%; left: 0px; top: 0px; z-index: -1;">
                            <img src="@GetIconURL(iconScan)" style="width: @(mWidth)px; height: @(mHeight)px;
	                                                                background-color: #121212; transform-origin: top left; @iconStyle">
                        </div>

                        <div style="overflow: hidden;">
                            @if (SettingsVM.LogDebug && !string.IsNullOrWhiteSpace(item.Name))
                            {
                                <div class="stroke">
                                    @item.Name
                                </div>
                            }
                            @if (item.Value > 0)
                            {
                                <div class="stroke">
                                    @item.Value.AsCredits()
                                </div>
                            }
                            @if (item.ValuePerSlot > 0)
                            {
                                <div class="stroke">
                                    @item.ValuePerSlot.AsCredits()
                                    <span class="ml-1">/ slot</span>
                                </div>
                            }
                            @if (!string.IsNullOrWhiteSpace(item.Rarity))
                            {
                                <div class="stroke">
                                    @item.Rarity
                                </div>
                            }
                            @if (item.Weight > 0)
                            {
                                <div class="stroke">
                                    @item.Weight.ToString("0.##") kg
                                </div>
                            }
                            @{
                                var recycleRec = item.GetRecycleRecommendation();
                                var recycleColor = recycleRec.decision switch {
                                    RecycleDecision.Recycle => "#ff9800",
                                    RecycleDecision.Keep => "#4caf50",
                                    _ => "#bdbdbd"
                                };
                                var recycleLabel = recycleRec.decision switch {
                                    RecycleDecision.Recycle => "RECYCLE",
                                    RecycleDecision.Keep => "KEEP",
                                    _ => "SELL"
                                };
                            }
                            <div class="d-flex align-center stroke" style="@($"color: {recycleColor};")" title="@recycleRec.reason">
                                <MudIcon Icon="@Icons.Material.Filled.Recycling" Size="Size.Small" Class="mr-1" /> @recycleLabel
                            </div>
                        </div>
                    </div>
                </div>
            }
            else
            {
                var leftPos = itemScan.GetToolTipPosition().X - VirtualScreenOffset.XOffset;
                var topPos = itemScan.GetToolTipPosition().Y - VirtualScreenOffset.YOffset;

                <MudPaper Elevation="4" Style="@($"position: absolute; left: {leftPos}px; top: {topPos}px; background-color: rgba(30, 30, 30, 0.95); max-width: 300px; border: 1px solid #495154; z-index: 9999;")" Class="pa-2 rounded">
                    <MudStack Spacing="1">
                         <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                             @if (!string.IsNullOrWhiteSpace(itemScan.IconPath))
                             {
                                 <img src="@GetIconURLFromPath(itemScan.IconPath, item.ImageLink ?? "")" style="width: 48px; height: 48px; object-fit: contain;" />
                             }
                             <MudStack Spacing="0">
                                 <MudText Typo="Typo.subtitle2" Style="font-weight: bold; color: white;">@item.Name</MudText>
                                 @if (!string.IsNullOrWhiteSpace(item.Rarity))
                                 {
                                     <MudText Typo="Typo.caption" Style="color: #bdbdbd;">@item.Rarity</MudText>
                                 }
                             </MudStack>
                         </MudStack>

                        <MudDivider Class="my-1" />

                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                             <MudText Typo="Typo.body1" Style="color: #bdbdbd;">Value:</MudText>
                             <MudText Typo="Typo.h6" Style="font-weight: bold; color: #FFD700;">@item.Value.AsCredits()</MudText>
                        </MudStack>
                        
                        @if (item.Weight > 0)
                        {
                            <MudStack Row="true" Justify="Justify.SpaceBetween">
                                 <MudText Typo="Typo.body2" Style="color: #bdbdbd;">Weight:</MudText>
                                 <MudText Typo="Typo.body2" Style="color: white;">@item.Weight.ToString("0.##") kg</MudText>
                            </MudStack>
                        }

                        @{
                             var recycleRec = item.GetRecycleRecommendation();
                             var recycleColor = recycleRec.decision switch {
                                 RecycleDecision.Recycle => "#ff9800",
                                 RecycleDecision.Keep => "#4caf50",
                                 _ => "#D32F2F"
                             };
                             var recycleLabel = recycleRec.decision switch {
                                 RecycleDecision.Recycle => "RECYCLE",
                                 RecycleDecision.Keep => "KEEP",
                                 _ => "SELL"
                             };
                             var recycleReason = recycleRec.reason ?? "";
                         }
                         
                         <MudAlert Class="mt-1 py-1" Severity="Severity.Normal" Variant="Variant.Filled" Style="@($"background-color: {recycleColor}; color: {(recycleRec.decision == RecycleDecision.Recycle ? "black" : "white")}; font-weight: bold;")" Icon="@Icons.Material.Filled.Recycling">
                            @recycleLabel @(string.IsNullOrEmpty(recycleReason) ? "" : $"- {recycleReason}")
                         </MudAlert>

                    </MudStack>
                </MudPaper>
            }
        }
    }
</div>

@code {
    private string GetIconURL(ItemIconScan itemScan)
    {
        return GetIconURLFromPath(itemScan.IconPath, itemScan.Item.ImageLink ?? "");
    }

    private string GetIconURLFromPath(string? path, string fallback)
    {
        if (string.IsNullOrEmpty(path)) return fallback;

        path = path.Replace("\\", "/");
        var iconsIndex = path.IndexOf("Data/icons/", System.StringComparison.OrdinalIgnoreCase);
        if (iconsIndex >= 0)
        {
            var pathEnd = path[iconsIndex..path.Length];
            pathEnd = pathEnd[5..pathEnd.Length];
            return "https://local.data/" + pathEnd;
        }

        var dataIndex = path.IndexOf("Data/", System.StringComparison.OrdinalIgnoreCase);
        if (dataIndex >= 0)
        {
            var pathEnd = path[(dataIndex + 5)..path.Length];
            return "https://local.data/" + pathEnd;
        }

        return fallback;
    }

    protected override void OnInitialized()
    {
        MenuVM.PropertyChanged += PropertyChangeHandler;
    }

    private async void PropertyChangeHandler(object? sender, EventArgs e)
    {
        await InvokeAsync(() => StateHasChanged());
    }

    public void Dispose()
    {
        MenuVM.PropertyChanged -= PropertyChangeHandler;
    }
}
